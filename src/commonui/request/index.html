<!DOCTYPE html>
<html>

<head>
    <title>CORS proxy</title>
</head>

<html>
<script src="superagent@5.2.2.min.js"></script>
<script>
    function arrayBufferToArray(buf) {
        var bytes = new Uint8Array(buf);
        return Array.from ? Array.from(bytes) : [].slice.call(bytes);
    }

    function postFmtMsg(id, err, res) {
        var fileReader = new FileReader();
        fileReader.onload = function (e) {
            var arrayBuffer = this.result;
            res.body = arrayBufferToArray(arrayBuffer);
            postMsg(id, err, res);
        };
        fileReader.readAsArrayBuffer(res.body);
    }

    function postFmtTextMsg(id, err, res) {
        var fileReader = new FileReader();
        fileReader.onload = function (e) {
            res.body = JSON.parse(this.result);
            postMsg(id, err, res);
        };
        fileReader.readAsText(res.body)
    }

    function makeUrlLocal(url) {
        url = url.replace(/^[a-zA-Z]+:/, '');
        url = url.replace(/^\/\/[^\/]+/, '');
        url = url.replace(/^\//, '');
        var localUrl = window.location.protocol + '//' + window.location.host + '/' + url;
        return localUrl;
    }

    function postMsg(id, err, res) {
        parent.postMessage(
            JSON.stringify({
                id: id,
                err: err,
                res: res
            }),
            '*'
        );
    }
    window.addEventListener('message', function (evt) {
        var data = JSON.parse(evt.data);
        if (evt.origin.indexOf(data.origin) < 0) return;
        data.data.id = data.id;
        data = data.data;
        var localUrl = makeUrlLocal(data.url);
        var request = superagent(data.method, localUrl);

        request
            .query(data.query && data.query.join('&'))
            .timeout(data.timeout)
            .set(data.header);

        if (!data.isMultipart) {
            data.type === 'blob' && request.responseType('blob');
            
            request
                .send(data.data)
                .set('Content-Type', 'application/json');
        } else {
            for (var key in data.data) {
                request.field(key, data.data[key]);
            }
        }

        request.end(function (err, res) {
                if (data.type === 'blob') {
                    if (!err) {
                        postFmtMsg(data.id, err, res);
                    } else {
                        postFmtTextMsg(data.id, err, res);
                    }
                } else {
                    postMsg(data.id, err, res)
                }
            });
    });
    if (window.parent !== window) {
        window.parent.postMessage(
            JSON.stringify({
                type: 'ready'
            }),
            '*'
        );
    }

</script>
</body>

</html>
